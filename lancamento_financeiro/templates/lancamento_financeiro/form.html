{% extends 'base.html' %}

{% block title %}
    {% if form.instance.id %}SGF - Editar{% else %}SGF - Novo{% endif %} Lançamento Financeiro
{% endblock %}

{% block content %}
{% if form.non_field_errors %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ form.non_field_errors }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
{% endif %}

<div class="card">
    <div class="card-header">
        <h3>{% if form.instance.id %}Editar{% else %}Novo{% endif %} Lançamento Financeiro</h3>
    </div>
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            
            <div class="row">
                <!-- Datas -->
                <div class="col-md-6 mb-3">
                    <label for="{{ form.data_emissao.id_for_label }}" class="form-label">Data de Emissão</label>
                    {{ form.data_emissao }}
                    {% if form.data_emissao.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.data_emissao.errors }}
                    </div>
                    {% endif %}
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="{{ form.data_vencimento.id_for_label }}" class="form-label">Data de Vencimento</label>
                    {{ form.data_vencimento }}
                    {% if form.data_vencimento.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.data_vencimento.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="row">
                <!-- Plano de Contas -->
                <div class="col-md-4 mb-3">
                    <label for="{{ form.classe.id_for_label }}" class="form-label">Classe</label>
                    {{ form.classe }}
                    {% if form.classe.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.classe.errors }}
                    </div>
                    {% endif %}
                </div>
                
                <div class="col-md-4 mb-3">
                    <label for="{{ form.grupo.id_for_label }}" class="form-label">Grupo</label>
                    {{ form.grupo }}
                    {% if form.grupo.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.grupo.errors }}
                    </div>
                    {% endif %}
                </div>
                
                <div class="col-md-4 mb-3">
                    <label for="{{ form.natureza.id_for_label }}" class="form-label">Natureza</label>
                    {{ form.natureza }}
                    {% if form.natureza.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.natureza.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="row">
                <!-- Centro de Custo e Movimento -->
                <div class="col-md-6 mb-3">
                    <label for="{{ form.centro_custo.id_for_label }}" class="form-label">Centro de Custo</label>
                    {{ form.centro_custo }}
                    {% if form.centro_custo.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.centro_custo.errors }}
                    </div>
                    {% endif %}
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="{{ form.movimento_caixa.id_for_label }}" class="form-label">Movimento de Caixa</label>
                    {{ form.movimento_caixa }}
                    {% if form.movimento_caixa.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.movimento_caixa.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="row">
                <!-- Conta e Cartão -->
                <div class="col-md-6 mb-3">
                    <label for="{{ form.conta.id_for_label }}" class="form-label">Conta</label>
                    {{ form.conta }}
                    {% if form.conta.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.conta.errors }}
                    </div>
                    {% endif %}
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="{{ form.cartao.id_for_label }}" class="form-label">Cartão</label>
                    {{ form.cartao }}
                    {% if form.cartao.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.cartao.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="row">
                <!-- Operação e Status -->
                <div class="col-md-6 mb-3">
                    <label for="{{ form.operacao.id_for_label }}" class="form-label">Operação</label>
                    {{ form.operacao }}
                    {% if form.operacao.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.operacao.errors }}
                    </div>
                    {% endif %}
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="{{ form.status_movimento.id_for_label }}" class="form-label">Status do Movimento</label>
                    {{ form.status_movimento }}
                    {% if form.status_movimento.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.status_movimento.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="row">
                <!-- Forma de Pagamento e Parcelas -->
                <div class="col-md-4 mb-3">
                    <label for="{{ form.forma_pagamento.id_for_label }}" class="form-label">Forma de Pagamento</label>
                    {{ form.forma_pagamento }}
                    {% if form.forma_pagamento.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.forma_pagamento.errors }}
                    </div>
                    {% endif %}
                </div>
                
                <div class="col-md-4 mb-3">
                    <label for="{{ form.quantidade_parcela.id_for_label }}" class="form-label">Quantidade de Parcelas</label>
                    {{ form.quantidade_parcela }}
                    {% if form.quantidade_parcela.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.quantidade_parcela.errors }}
                    </div>
                    {% endif %}
                </div>
                
                <div class="col-md-4 mb-3">
                    <label for="{{ form.valor.id_for_label }}" class="form-label">Valor</label>
                    {{ form.valor }}
                    {% if form.valor.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.valor.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="mb-3">
                <label for="{{ form.descricao.id_for_label }}" class="form-label">Descrição</label>
                {{ form.descricao }}
                {% if form.descricao.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.descricao.errors }}
                </div>
                {% endif %}
            </div>
            
            <div class="d-flex justify-content-between">
                <a href="{% url 'lancamento_financeiro:list' %}" class="btn btn-secondary">Voltar</a>
                <button type="submit" class="btn btn-primary">Salvar</button>
            </div>
        </form>
    </div>
</div>

<!-- Script para lidar com dependências entre campos -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const formaPagamentoSelect = document.getElementById('{{ form.forma_pagamento.id_for_label }}');
    const qtdParcelaInput = document.getElementById('{{ form.quantidade_parcela.id_for_label }}');
    const cartaoField = document.getElementById('{{ form.cartao.id_for_label }}').parentElement;
    
    // Quando a forma de pagamento muda
    formaPagamentoSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex].text.toLowerCase();
        
        // Verificar se é à vista
        if (selectedOption.includes('vista')) {
            qtdParcelaInput.value = 1;
            // qtdParcelaInput.disabled = true;
            qtdParcelaInput.disabled = false;
        } else {
            qtdParcelaInput.disabled = false;
        }
        
        // Verificar se precisa de cartão
        if (selectedOption.includes('cartão') || selectedOption.includes('cartao')) {
            cartaoField.style.display = 'block';
            document.getElementById('{{ form.cartao.id_for_label }}').required = true;
        } else {
            cartaoField.style.display = 'block'; // Mantém visível mas não obrigatório
            document.getElementById('{{ form.cartao.id_for_label }}').required = false;
        }
    });
    
    // Trigger the event on page load
    const event = new Event('change');
    formaPagamentoSelect.dispatchEvent(event);
});

// Lógica para armazenar as colunas corretas dos campos classe, grupo e natureza
// Adicione esse script ao seu arquivo form.html
document.addEventListener('DOMContentLoaded', function() {
    // Campos do formulário
    const classeSelect = document.getElementById('id_classe');
    const grupoSelect = document.getElementById('id_grupo');
    const naturezaSelect = document.getElementById('id_natureza');
    
    // Campos ocultos para os códigos
    const codClasseInput = document.getElementById('id_cod_classe');
    const codGrupoInput = document.getElementById('id_cod_grupo');
    const codNaturezaInput = document.getElementById('id_cod_natureza');
    
    // Função para extrair o código da opção selecionada (formato: "COD_XXXX - Descrição")
    function extractCode(optionText) {
        if (!optionText) return '';
        const parts = optionText.split(' - ');
        return parts.length > 0 ? parts[0].trim() : '';
    }
    
    // Função para atualizar os campos ocultos quando os selects mudam
    function updateCodFields() {
        if (classeSelect && classeSelect.selectedIndex > 0) {
            const selectedOption = classeSelect.options[classeSelect.selectedIndex];
            const codClasse = extractCode(selectedOption.text);
            if (codClasseInput) codClasseInput.value = codClasse;
        }
        
        if (grupoSelect && grupoSelect.selectedIndex > 0) {
            const selectedOption = grupoSelect.options[grupoSelect.selectedIndex];
            const codGrupo = extractCode(selectedOption.text);
            if (codGrupoInput) codGrupoInput.value = codGrupo;
        }
        
        if (naturezaSelect && naturezaSelect.selectedIndex > 0) {
            const selectedOption = naturezaSelect.options[naturezaSelect.selectedIndex];
            const codNatureza = extractCode(selectedOption.text);
            if (codNaturezaInput) codNaturezaInput.value = codNatureza;
        }
    }
    
    // Adicionar event listeners para os selects se eles existirem
    if (classeSelect) {
        classeSelect.addEventListener('change', updateCodFields);
    }
    
    if (grupoSelect) {
        grupoSelect.addEventListener('change', updateCodFields);
    }
    
    if (naturezaSelect) {
        naturezaSelect.addEventListener('change', updateCodFields);
    }
    
    // Atualizar campos ao carregar a página (para edições)
    updateCodFields();
});
</script>
{% endblock %}